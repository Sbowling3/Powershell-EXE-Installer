Add-Type -AssemblyName System.Windows.Forms

# Function to check if lgpo command is available
function Check-LGPO {
    $lgpoPath = Get-Command "lgpo" -ErrorAction SilentlyContinue
    if (-not $lgpoPath) {
        [System.Windows.Forms.MessageBox]::Show("You Need to Install LGPO first!", "LGPO Not Found", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Error)
        Exit
    }
}

# Check for LGPO command
Check-LGPO

# Get all local users ending with .adm
$admUsers = Get-LocalUser | Where-Object { $_.Name -like "*.adm" } | Select-Object -ExpandProperty Name

# Loop through each user and apply the lgpo command
foreach ($user in $admUsers) {
    $command = "lgpo /u:$user 'Media Control\Block_ALL.pol'"
    Write-Host "Executing: $command"
    Invoke-Expression $command
}

# Run gpupdate to apply the policy changes
Write-Host "Updating group policies..."
gpupdate /force
